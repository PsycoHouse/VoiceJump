<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Wizard ‚Äì Zauber den Ball</title>
  <style>
    :root{
      --bg:#0c1022;
      --panel:#141b2f;
      --fg:#eaf0ff;
      --muted:#9aa3b2;
      --acc:#7cc6ff;
      --ok:#7dffb0;
      --radius:18px;
      --shadow:0 12px 36px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:radial-gradient(1000px 600px at 70% -200px,#1a2240,var(--bg));color:var(--fg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:960px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(1.2rem,3.2vw,2rem);display:flex;align-items:center;gap:.6ch}
    .badge{font-size:.8rem;color:#061525;background:linear-gradient(135deg,var(--ok),var(--acc));padding:4px 10px;border-radius:999px;font-weight:800}
    .panel{margin-top:14px;background:rgba(20,27,47,.7);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.07);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    select,button{background:var(--panel);color:var(--fg);border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover,select:hover{border-color:rgba(255,255,255,.25)}
    .micdot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;background:#999}
    .mic-on{background:var(--ok)}
    .mic-off{background:#999}
    .mic-err{background:#ff6b6b}
    canvas{width:100%;height:auto;display:block;border-radius:18px;border:1px solid rgba(255,255,255,.09);box-shadow:var(--shadow);
      background:#0a0f1f;margin-top:16px}
    .sentence{font-weight:700;font-size:clamp(1rem,3vw,1.6rem);text-align:center;margin-top:10px}
    .energy-bar{height:28px;border:1px solid rgba(255,255,255,.15);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.05);margin-top:10px}
    #energyFill{height:100%;width:0;background:linear-gradient(90deg,var(--acc),var(--ok))}
    .damage-bar{height:28px;border:1px solid rgba(255,255,255,.15);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.05);margin-top:10px}
    #damageFill{height:100%;width:0;background:linear-gradient(90deg,#ff7d7d,#ffb07d)}
    .lastspeech{color:var(--muted);font-size:.95rem;margin-top:6px}
    .missed{color:#ff9f7d;font-size:.95rem;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
        <h1>üéôÔ∏è Voice Wizard <span class="badge">Sprich den Zauberspruch!</span></h1>
      <div>
        <span class="micdot mic-off" id="micdot" aria-hidden="true"></span>
        <span id="micStatus">Mikro aus</span>
      </div>
    </header>

    <div class="panel">
      <div class="sentence" id="sentence">‚Äì</div>
      <div class="energy-bar"><div id="energyFill"></div></div>
      <div class="damage-bar"><div id="damageFill"></div></div>
      <div class="controls">
        <button id="btnMicStart">üé§ Mikro starten</button>
        <button id="btnMicStop">Mikro stoppen</button>
      </div>
      <div class="lastspeech" id="heard">‚Äì</div>
      <div class="missed" id="missed">¬†</div>
      <canvas id="game" width="960" height="540" aria-label="Spielbereich"></canvas>
    </div>
  </div>

    <script>
    const SPELLS=[
      "Mit funkelnder Stimme flehe ich die Kr√§fte des Mondes der Sterne des Windes und der Erde an diese Kugel der Macht zu formen und meine Feinde zu zerschmettern",
      "Durch alte Worte und ewige Runen lenke ich das Licht der Elemente auf dass diese strahlende Sph√§re die Dunkelheit vertreibe und unsere Herzen mit Mut erf√ºlle",
      "Oh Quellen des Lebens h√∂rt meinen Ruf und webt aus Feuer Wasser Luft und Stein einen kreisenden Ball der uns sch√ºtzt und jeden Gegner in die Flucht schl√§gt"
    ];

    const sentenceEl=document.getElementById('sentence');
    const energyFill=document.getElementById('energyFill');
    const damageFill=document.getElementById('damageFill');
    const heardEl=document.getElementById('heard');
    const missedEl=document.getElementById('missed');
    const micdot=document.getElementById('micdot');
    const micStatus=document.getElementById('micStatus');
    const btnMicStart=document.getElementById('btnMicStart');
    const btnMicStop=document.getElementById('btnMicStop');

    const cvs=document.getElementById('game');
    const ctx=cvs.getContext('2d');
    const W=cvs.width,H=cvs.height;
    const wizardPos={x:100,y:H-80};
    const targetPos={x:W-100,y:H-80};
    const wizardImg=new Image(); // wizardImg.src='pfad/zum/zauberer.png';
    const enemyImg=new Image(); // enemyImg.src='pfad/zum/gegner.png';

    let recognition=null;
    const state={
      damage:0,
      currentText:"",
      ball:null,
      micAvailable:!!(window.SpeechRecognition||window.webkitSpeechRecognition),
      micActive:false,
      wantMic:false,
      canCast:true
    };

    function randSpell(){return SPELLS[(Math.random()*SPELLS.length)|0];}
    function newSpell(){state.currentText=randSpell(); sentenceEl.textContent=state.currentText;}
    function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
    function updateDamage(){damageFill.style.width=state.damage+"%";}
    function addDamage(amount){state.damage=clamp(state.damage+amount,0,100);updateDamage();}
    function compareSpell(expected,actual){
      const clean=s=>s.toLowerCase().replace(/[^\w√§√∂√º√ü ]/g,'').split(/\s+/).filter(Boolean);
      const exp=clean(expected),act=clean(actual);
      let i=0;
      for(;i<exp.length&&i<act.length;i++){
        if(exp[i]!==act[i]) break;
      }
      return {correct:i,total:exp.length};
    }
    function shoot(correct,total){
      const ratio=correct/total;
      const r=10+ratio*40;
      state.ball={x:wizardPos.x,y:wizardPos.y-30,r:r,damage:correct*5};
      state.canCast=false;
      energyFill.style.width=ratio*100+"%";
    }

    function update(dt){
      if(state.ball){
        state.ball.x+=400*dt;
        if(state.ball.x>=targetPos.x){
          addDamage(state.ball.damage);
          state.ball=null;
          state.canCast=true;
          newSpell();
          if(state.wantMic){try{recognition.start();}catch{}}
        }
      }
    }
    function roundRect(x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
    function draw(){
      ctx.clearRect(0,0,W,H);
      // wizard
      if(wizardImg.src){
        ctx.drawImage(wizardImg,wizardPos.x-40,wizardPos.y-120,80,120);
      }else{
        ctx.fillStyle='#7cc6ff';
        roundRect(wizardPos.x-20,wizardPos.y-60,40,60,10);ctx.fill();
        ctx.beginPath();ctx.arc(wizardPos.x,wizardPos.y-70,14,0,Math.PI*2);ctx.fillStyle='#eaf6ff';ctx.fill();
        ctx.fillStyle='#0a0f1f';ctx.fillRect(wizardPos.x-25,wizardPos.y-90,50,10);
        ctx.beginPath();ctx.moveTo(wizardPos.x,wizardPos.y-120);ctx.lineTo(wizardPos.x-20,wizardPos.y-90);ctx.lineTo(wizardPos.x+20,wizardPos.y-90);ctx.closePath();ctx.fill();
      }
      // target
      if(enemyImg.src){
        ctx.drawImage(enemyImg,targetPos.x-40,targetPos.y-120,80,120);
      }else{
        ctx.fillStyle='#ff9f7d';
        roundRect(targetPos.x-20,targetPos.y-60,40,60,10);ctx.fill();
      }
      // ball
      if(state.ball){
        const b=state.ball;
        const grd=ctx.createRadialGradient(b.x,b.y,b.r*0.2,b.x,b.y,b.r);
        grd.addColorStop(0,'#a4e5ff');
        grd.addColorStop(1,'#7dffb0');
        ctx.fillStyle=grd;
        ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
      }
    }
    let last=performance.now();
    function tick(now){const dt=(now-last)/1000;last=now;update(dt);draw();requestAnimationFrame(tick);} requestAnimationFrame(tick);

    function updateMicUI(mode='off'){
      micdot.classList.remove('mic-on','mic-off','mic-err');
      if(mode==='on'){micdot.classList.add('mic-on');micStatus.textContent='Mikro an';}
      else if(mode==='err'){micdot.classList.add('mic-err');micStatus.textContent='Mikro Fehler';}
      else{micdot.classList.add('mic-off');micStatus.textContent=state.micAvailable?'Mikro aus':'Kein Sprach-API';}
    }
    updateMicUI('off');

    function initRecognition(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){state.micAvailable=false;updateMicUI('err');return;}
      recognition=new SR();
      recognition.lang='de-DE';
      recognition.continuous=true;
      recognition.interimResults=true;
      recognition.onstart=()=>{state.micActive=true;updateMicUI('on');};
      recognition.onerror=e=>{console.warn('Speech error',e);updateMicUI('err');};
        recognition.onend=()=>{state.micActive=false;updateMicUI('off');if(state.wantMic&&state.canCast){try{recognition.start();}catch{}}};
      recognition.onresult=event=>{
        for(let i=event.resultIndex;i<event.results.length;i++){
          const res=event.results[i];
          const txt=res[0].transcript.trim();
          if(res.isFinal && state.canCast){
            heardEl.textContent=txt||'‚Äì';
            const {correct,total}=compareSpell(state.currentText,txt);
            const dmg=correct*5;
            missedEl.textContent=`Korrekt: ${correct}/${total} ‚Äì Schaden: ${dmg}`;
            shoot(correct,total);
            recognition.stop();
          }
        }
      };
    }

    btnMicStart.addEventListener('click',()=>{
      if(!recognition) initRecognition();
      if(!recognition) return;
      try{state.wantMic=true; recognition.start();}catch{}
    });
    btnMicStop.addEventListener('click',()=>{
      state.wantMic=false;
      try{recognition&&recognition.stop();}catch{}
    });

    newSpell();
    </script>
</body>
</html>
